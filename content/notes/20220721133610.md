+++
title = "ğŸ“Clojure Bot Development"
lastmod = 2022-10-26T11:02:53+09:00
tags = ["WIKI"]
draft = false
+++

Bot/Scheduler development with Clojure.

Clojureã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¾ã¨ã‚.

-   up: [ğŸ“‚Clojureé–‹ç™º]({{< relref "20220211141917.md" >}})
-   tags. [ğŸ”–Bot]({{< relref "20221010065234.md" >}})
-   refs
    -   [ğŸ“ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°]({{< relref "20220310100122.md" >}})


## Overview {#3b8782}

Clojureã®Boté–‹ç™ºã«ã¤ã„ã¦ã®çŸ¥è¦‹ã‚’ã¾ã¨ã‚ã¦ã„ã. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æŒãŸãªã„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º, ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯, ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©, Botãªã©ãªã©...

Clojureã§æ‰‹ç¶šããƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãªloopã‚’æ›¸ã„ãŸã‚ŠçŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’çŸ¥ã‚ŠãŸã„. ã©ã†ã‚‚æ‰‹ç¶šãçš„ãªæ–¹æ³•ã‚’ãã®ã¾ã¾å°å…¥ã™ã‚‹ã“ã¨ã«ã¯é•å’Œæ„ŸãŒã‚ã‚‹. ã‚‚ã—ãã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¤ã‹ã†ã‹. ç¾åœ¨ã®ä»®ã®ç­”ãˆã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒãƒ£ãƒ¼ãƒˆç³»ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åˆ©ç”¨([clj-statechats]({{< relref "20220211142329.md#e9175a11-61e8-41f2-a1bc-1afacbb79911" >}})).

HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ä¾å­˜ã™ã‚‹ã‚‚ã®ã¯[ğŸ“Clojure Web Development]({{< relref "20220118092453.md" >}}), ã‚‚ã—ãã¯[ğŸ“Clojure API Server Development]({{< relref "20220226220442.md" >}}).

ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼é–‹ç™ºã®å®šæœŸå®Ÿè¡Œã¯ã“ã®ãƒ¡ãƒ¢ã«, ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æŠ€è¡“ã¯[ğŸ“Clojure Scraping]({{< relref "20220426214300.md" >}})ã¸.

ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹åŒ–ã¯ã‚µãƒ–ãƒ¡ãƒ¢ã¸.

-   [ğŸ“Clojure Trading Bot Development]({{< relref "20220714214503.md" >}})
-   [ğŸ“Twitter App Development with Clojure]({{< relref "20220307193727.md" >}})
-   [ğŸ“Clojure Scraping]({{< relref "20220426214300.md" >}})


## Clojureã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å®Ÿè£… {#73d177}


### Clojureã§ã®ç„¡é™ãƒ«ãƒ¼ãƒ—å®Ÿè£…æ–¹æ³• {#7f451a}

cronã‚’clojureã§å®Ÿç¾ã—ã‚ˆã†ã¨ã—ãŸã¨ãã¯ç„¡é™ã®é…å»¶ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æ‰±ã†ã“ã¨ã«ãªã‚‹.

ãƒãƒƒãƒˆã®æƒ…å ±ã ã¨webã‚µãƒ¼ãƒãŒå¤šã„ã®ã ãŒ, ã‚‚ã¯ã‚„[ğŸ“Web Server Abstruction]({{< relref "20220220095102.md#b3ffbbed-04db-485d-81dc-e84680c2c11a" >}})ã‚„ãã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯å†…éƒ¨ã®ä»•çµ„ã¿ãŒéš è”½ã•ã‚Œã¦å®Œæˆã•ã‚Œã¦ã„ã‚‹ã®ã§, ãªã‹ãªã‹ã‚µãƒ¼ãƒã®ãªã‹ãŒãªã«ã‚’ã‚„ã£ã¦ã„ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„.

ã“ã‚Œã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã®ãŒã„ã„. [chime](https://github.com/jarohen/chime)ãŒã¾ãšé¸æŠè‚¢ã¨ã—ã¦ä¸ŠãŒã‚‹.


### core.async/timeoutã‚’ã¤ã‹ã† {#0d7193}

ä»–ã«ã¯, [ğŸ“Clojure core.async]({{< relref "20220118091058.md" >}})ã®go-loopã‚’ã¤ã‹ã†.

ref. [How to schedule a list of functions \`n\` seconds apart with Clojure Core Async - Stack Overflow](https://stackoverflow.com/questions/66500942/how-to-schedule-a-list-of-functions-n-seconds-apart-with-clojure-core-async)

```clojure
(a/go-loop []
  (a/<! (a/timeout 3000))
  (println "Hello!")
  (recur))
```

æ­¢ã¾ã‚‰ãªã„ã®ã§æ³¨æ„. æ­¢ã‚ã‚‹ã«ã¯exit-chã¿ãŸã„ãªå¤–éƒ¨ã‹ã‚‰æ“ä½œã§ãã‚‹channelã‚’åˆ¥é€”ç”¨æ„.

-   refs.
    -   [java - Gracefully exit a Clojure core.async go loop on kill - Stack Overflow](https://stackoverflow.com/questions/20485188/gracefully-exit-a-clojure-core-async-go-loop-on-kill)
    -   [The "kill pattern" in Clojure's core.async | The Gentleman Programmer](https://freckletonj.github.io/posts/2016-01-03-core-async-kill-pattern/)

componentã‚„integrantã®ã‚ˆã†ãª[Clojure: çŠ¶æ…‹ç®¡ç†ã¨ã‚·ã‚¹ãƒ†ãƒ ]({{< relref "20220211142329.md#497a8160-d192-45db-aa0c-84b9a2442861" >}})ã‚’å°å…¥ã—ã¦çµ‚äº†æ™‚ã«ç¢ºå®Ÿã«channelã‚’é–‰ã˜ã‚‹ä»•çµ„ã¿ã‚’ã„ã‚Œã‚‹ã®ã‚‚ã‚ˆã„.

```clojure
(defmethod ig/init-key ::watcher [_ _]
  (let [ch (a/chan (a/sliding-buffer 1))]
    (a/go-loop []
      (if-let [msg (a/<! ch)]
        (do
          (do-something!)
          (a/<! (a/timeout 3000))
          (recur))
        (println "Done.")))
    ch))

(defmethod ig/halt-key! ::watcher [_ ch]
  (a/close! ch))
```


### core.asyncã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å®Ÿè£…ä¾‹ {#8e420c}

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã ã¨[ğŸ“re-frame]({{< relref "20220515174141.md" >}})ã®ã‚ˆã†ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ´»ç”¨ã™ã‚‹ã®ãŒã„ã„. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç°¡æ˜“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã™ã‚‹.

ãã‚“ãªã«ã—ã£ã‹ã‚Šã—ãŸã‚‚ã®ã§ãªã‘ã‚Œã°, ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’æ”¹é€ ã™ã‚Œã°ã„ã„. ä»¥ä¸‹ã¯core.asyncã‚’æ´»ç”¨ã—ãŸä¾‹.

[Implementing an Event-Driven ClojureScript mini-framework with core.async](https://dawranliou.com/blog/event-driven-clojurescript-front-end-with-core-async/)


## Clojure Schedular: å®šæœŸå®Ÿè¡Œ {#dcb543}

[ğŸ“cron]({{< relref "20220528093833.md" >}})çš„ãªã‚‚ã®ã‚’Clojureã§ã©ã†ã‚„ã‚‹ã‹.


### çŠ¶æ…‹ç®¡ç† {#0ee8ae}

ã†ã£ã‹ã‚ŠREPLã¨ã‹ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’èµ°ã‚‰ã›ã‚‹ã¨REPLã‚’å†èµ·å‹•ã—ãªã„ã¨æ­¢ã‚ã‚‰ã‚Œãªã„ãŸã‚, çŠ¶æ…‹ç®¡ç†ã®å·¥å¤«ãŒå¿…è¦(start/stop). Clojureã«ã¯çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã®ã§ãã‚Œã‚‰ã¨ãã¿ã‚ã‚ã›ã‚‹ã¨ã„ã„.

[ğŸ“Clojure Integrant]({{< relref "20220531084041.md" >}})

ä»¥ä¸‹ã®ä¾‹ã§ã¯duct(integrant)ã«chimeã‚’çµ„ã¿è¾¼ã‚“ã§ã„ã‚‹.

[duct-frameworkã«å®šæ™‚èµ·å‹•ã‚¸ãƒ§ãƒ–ã‚’ä»•è¾¼ã‚€ - Hash Î» Bye](https://ilyaletre.hatenablog.com/entry/2018/04/15/175037)


### çŠ¶æ…‹é·ç§» {#a50d14}

Finate State Machineçš„ãªã‚‚ã®ã‚’å°å…¥ã™ã‚‹.

[Clojure FSM]({{< relref "20220211142329.md#1401c497-200e-4f4a-a01c-1ce372308804" >}})


## Clojure: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ {#0c0c98}

-   [âš–Clojure: atom/delay/future/promiseã®æ¯”è¼ƒ]({{< relref "20220116191927.md#0cd352b6-a062-445a-bb00-dce7714f76ed" >}})


## Clojure: Chime {#9ac33f33-cf6f-49f4-ab5b-905dda5df207}

Clojureã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©é–‹ç™ºã®ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§æœ‰å. ãƒãƒ£ã‚¤ãƒ ã¨èª­ã‚€.

<https://github.com/jarohen/chime>

-   chime/chime-at: ã§æŒ‡å®šæ™‚åˆ»ã«å®Ÿè¡Œ.
-   chime/periodic-seq ã§ç„¡é™ãƒ«ãƒ¼ãƒ—


### chimeã®è¨­è¨ˆ {#b83bf4}

æ™‚é–“ã”ã¨ã®ç„¡é™ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’periodic-seqã§ä½œæˆã—ã¦, chime-atã§ãã®ç„¡é™ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä¸€ã¤ãšã¤æ¶ˆè²»ã—ã¦ã„ã. [source(GitHub)](https://github.com/jarohen/chime/blob/fa0b6e8c0f68e6d6134aee6ba9eb2ce032ba65b0/src/chime/core.clj#L112)

java.util.concurrent.ScheduleExecutorServiceã® **.schedule** ã‚’ã¤ã‹ã£ã¦ã„ã‚‹.

ref. [ScheduledExecutorService ä½¿ã„æ–¹ãƒ¡ãƒ¢ - Qiita](https://qiita.com/opengl-8080/items/ee8e926cf75e4d6058a2)


### ğŸ’¡chimeã®ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹æ–¹æ³• {#2f98cc}

> Returns an AutoCloseable that you can \`.close\` to stop the schedule.
> You can also deref the return value to wait for the schedule to finish.

(chime/chime-at)ã®æˆ»ã‚Šå€¤ã‚’atomãªã©ã«ä¿æŒã—ã¦ãŠã„ã¦, ãã®valueã«å¯¾ã—ã¦.closeã‚’å‘¼ã¶ã¨æ­¢ã¾ã‚‹.

```clojure
(def state
  (atom ((chime/chime-at interval-seq
                         exec
                         {:on-finished stop})))
(.close @state)
```


### ğŸ’¡ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é‹ç”¨ç¶™ç¶š/ä¸­æ–­ {#36d06a}

:error-handlerã®ã‚¿ã‚°ã«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æ¸¡ã™ã¨ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ã‚’è¨˜è¿°ã§ãã‚‹.

ã•ã‚‰ã«é–¢æ•°ãŒtrueã‚’è¿”ã™ã¨é‹ç”¨ç¶™ç¶š, not trueãªã‚‰ã°é‹ç”¨ä¸­æ–­ã™ã‚‹.


### chimeã®ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’main threadã«ãã£ã¤ã‘ã‚‹æ–¹æ³• {#a9e3a7}

**<!!** ã‚’ã¤ã‹ã†.

```clojure
(let [now (Instant/now)
      chimes (chime-ch [(.plusSeconds now 2)
                        (.plusSeconds now 3)])]
  (a/<!! (go-loop []
           (when-let [msg (<! chimes)]
             (prn "Chiming at:" msg)
             (recur)))))
```

READMEã®ã‚µãƒ³ãƒ—ãƒ«ãã®ã‚‚ã®ã ãŒ, a/<!!ã®éƒ¨åˆ†ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã„ã‚‹.

ref. [How to make a Clojure go loop run forever - Stack Overflow](https://stackoverflow.com/questions/42955568/how-to-make-a-clojure-go-loop-run-forever)


### ğŸ”—References {#3b90d2}

-   [duct-frameworkã«å®šæ™‚èµ·å‹•ã‚¸ãƒ§ãƒ–ã‚’ä»•è¾¼ã‚€ - Hash Î» Bye](https://ilyaletre.hatenablog.com/entry/2018/04/15/175037)
    -   integrantã¨chimeã®core.asyncé€£æºä¾‹.


## Clojure Bot Development Topics {#53abdf}


### ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®? {#d2dfac}

Javaã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§Javaã®æ–¹æ³•ã‚’æ¤œç´¢ã™ã‚‹ã¨ã„ã‚ã„ã‚ã§ã¦ãã‚‹.

-   ãƒ•ãƒ©ã‚°ã§åˆ¶å¾¡
    -   (core.async/channelã‚’ä»•è¾¼ã‚€)
-   å¤–éƒ¨ã‹ã‚‰ã®interrupt
-   java.io.Closableã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦.closeå‘¼ã³å‡ºã—.

ã‚ã¾ã‚Šè‡ªåˆ†ã§é ‘å¼µã‚‰ãšã«ãªã‚“ã‹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã®ã£ã‹ã£ãŸã»ã†ãŒã„ã„ã‹ã‚‚.
