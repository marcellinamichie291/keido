+++
title = "ğŸ“Clojure: Manifold"
lastmod = 2022-10-14T08:32:25+09:00
tags = ["WIKI", "Clojure"]
draft = false
+++

-   up: [ğŸ“Clojure State and Concurrency]({{< relref "20220116191927.md" >}})
-   links
    -   <https://github.com/clj-commons/manifold>


## ğŸ“Manifoldã¨ã¯ {#370573}

éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãŸã‚ã®éƒ¨å“ã‚’æä¾›.

2ã¤ã®æŠ½è±¡ãŒãƒã‚¤ãƒ³ãƒˆ.

-   deferreds
-   streams

deferredsã¨ã¯èãæ…£ã‚Œãªã„ãŒ, å»¶æœŸ, å…ˆå»¶ã°ã—ã®æ„å‘³. é…å»¶è©•ä¾¡ã¨ã„ã†ã“ã¨ã‹ãª? streamã¯ä¸¦è¡Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ãŠã‘ã‚‹[Streams]({{< relref "20220116195030.md#d1bfb9ba-5970-4e9e-ae14-ed2d2c692f81" >}})ã®æ¦‚å¿µ.

-   [manifold/doc](https://github.com/clj-commons/manifold/tree/master/doc) : GitHubã®READMEãŒè©³ã—ã„.
-   <https://cljdoc.org/d/manifold/manifold/>: API doc

Manifoldã®Streamã‚’åˆ©ç”¨ã—ã¦ä½œã‚‰ã‚ŒãŸé€šä¿¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ[aleph](#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8). alephã®æ–¹ã«ã‚‚Manifoldã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚‹.


### Base Concepts {#64345e}

**deferred**, ã¾ãŸã¯deferred valuesã¯é…å»¶ã•ã‚ŒãŸå€¤ã¨ã„ã†æ„å‘³. è©•ä¾¡ã•ã‚Œã¦ã„ãªã„å€¤. <<... >>ã¨ã„ã†ã‚ˆã†ãªäºŒé‡ã‚«ãƒƒã‚³ã§è¡¨ç¾ã•ã‚Œã‚‹. asynchronous valueã¨ã‚‚ã„ã‚ã‚Œã‚‹. Clojureã®promiseã«callbackã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ãªæ‹¡å¼µæ©Ÿèƒ½.

**stream** ã¯, deferred valuesã®ãƒªã‚¹ãƒˆ. **sink** ã¯ æƒ…å ±ã‚’æ¶ˆè²»(consume)ã™ã‚‹stream, **source** ã¯æƒ…å ±ã‚’ç”Ÿã¿å‡ºã™(produce)stream. ã“ã‚Œã‚‰ã®source/sinkã®2ã¤ã®streamãŒã‚»ãƒƒãƒˆã¨ã—ã¦ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å…¥ã£ã¦ã„ã‚‹. duplex streamã¨ã„ã†.

Manifoldã«ãŠã‘ã‚‹streamsã¯ã“ã®sinkã¨sourceã®ä¸¡æ–¹ã‚’ä½µã›æŒã¤ã‚³ãƒ³ã‚»ãƒ—ãƒˆ. sinkã«å¯¾ã—ã¦put!ã—ã¦, sourceã«å¯¾ã—ã¦take!ã™ã‚‹. Manifoldã®streamã§è¿”ã•ã‚Œã‚‹ã®ã¯duplex streamã®deferredã•ã‚ŒãŸçŠ¶æ…‹ã§ã‚ã‚‹ã®ã§, duplexã®æ§‹é€ ã¯å†…éƒ¨ã«éš è”½ã•ã‚Œã¦ã„ã‚‹ã®ã§è¤‡æ•°å½¢ã®streamsã§ã¯ãªãå˜æ•°å½¢ã®streamã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã¨ã“ã‚ã¯å°‘ã—ã‚„ã‚„ã“ã—ã„.

ãªã«ã‚‚å–ã‚Šå‡ºã›ãªã„çŠ¶æ…‹, ç©ºã®sourceã¯ **drained** (æ¯æ¸‡)ã¨ã„ã†çŠ¶æ…‹ã«ãªã‚‹.


### Deferreds {#a2c9c2}

<https://github.com/clj-commons/manifold/blob/master/doc/deferred.md>

deferred valueã¯@ã ã£ãŸã‚Šderefã§èª­ã‚€.


### Streams {#21b3cb}

ref. <https://github.com/clj-commons/manifold/blob/master/doc/stream.md>

streamã®å‹ã‚’typeã§èª¿ã¹ã‚‹ã¨, SplicedStreamã¨ãªã‚‹. spliceã¯ä½™ã‚Šãã‹ãªã„è‹±å˜èªã ãŒ, é€£çµã•ã‚ŒãŸã®æ„.


### Event-Bus {#0637bb}

[âš™Publisher-Subscriberãƒ‘ã‚¿ãƒ¼ãƒ³]({{< relref "20221008220000.md#0b8b761b-2fb9-48f1-9777-cc09e92bed6c" >}})ã‚’å®Ÿç¾ã‚‹ã™ãŸã‚ã®æ©Ÿèƒ½.

ã‚ã¾ã‚Šæƒ…å ±ãŒãªã„ãŒ, ä»¥ä¸‹ã®è¨˜äº‹ã¯è©³ã—ã„.

[A Tour of Manifoldâ€™s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)

ã‚‚ã—ãã¯core.asyncã® [pub/sub]({{< relref "20220118091058.md#7c997455-af40-4663-b841-7b0e6f39ec19" >}})ã‹ã‚‰é¡æ¨.

[Zach Tellman - Everything Will Flow - YouTube](https://www.youtube.com/watch?v=1bNOO3xxMc0&t=1887s)


## ğŸ“Clojure: aleph {#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8}

éåŒæœŸé€šä¿¡ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª.

(core.asyncã§ã¯ãªã)[ğŸ“Manifold]({{< relref "20221013151243.md" >}})ã®Streamã‚’Baseã«ã—ãŸä¸¦è¡Œåˆ¶å¾¡ã¨[Netty]({{< relref "20221011163921.md#08d70e13-298f-49af-a58d-c0dbeb76d660" >}})ã«ã‚ˆã‚‹éåŒæœŸé€šä¿¡ã‚’Baseã«ã—ã¦ã„ã‚‹.

READMEã«ã‚ˆã‚‹ã¨, HTTPé€šä¿¡ã¯[clj-http]({{< relref "20220209102028.md#13a79f1f-0d95-4f2a-8c4c-b77c4ed69be1" >}})ã®mimicã‚’ç›®æŒ‡ã™. mimicã¨ã¯ãªã‚“ã ?èª¿ã¹ãŸæ¨¡å€£ã¨ã„ã†æ„å‘³ã‚‰ã—ã„.

---

-   <https://aleph.io/aleph/http.html>
-   <https://aleph.io/examples/literate.html>
-   <https://aleph.io/codox/manifold/index.html>
-   [GitHub - clj-commons/aleph: Asynchronous communication for Clojure](https://github.com/clj-commons/aleph)

å‚è€ƒè¨˜äº‹.

-   [aleph/lamina: Clojureã§ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆWebSocket - Qiita](https://qiita.com/federkasten/items/8d10f12f049aec9a236f)
-   [Clojure: aleph.tcpã‚’ä½¿ã£ã¦http echoã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã£ã¦éŠã¶ - Qiita](https://qiita.com/temp_la/items/866a58f60bcd2e5593e4)
-   [Using Aleph as a Clojure WebSocket Client | Matthew Downey](https://matthewdowney.github.io/aleph-websocket-client-not-jetty.html)


### Websocket Clinet Basics {#266090}

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®åŸºæœ¬.

```clojure
(def ws-url "wss://ws.lightstream.bitflyer.com/json-rpc")
(def sock @(websocket-client ws-url))

(let [msg
      {:method "subscribe"
       :params {:channel "lightning_ticker_FX_BTC_JPY"}}]
  (s/put! sock (generate-string msg)))
```


## Manifold Topics {#2ab9b4}


### streamã®çŠ¶æ…‹ã‚’èª¿ã¹ã‚‹é–¢æ•° {#db3c19}

ã„ã‚ã„ã‚ã‚ã‚‹ãŒ, descriptionã¨ã„ã†é–¢æ•°ã§å…¨éƒ¨Mapã§æƒ…å ±ãŒå–ã‚Œã‚‹.

-   drained?
-   sink?
-   source?
-   closed?
-   stream?


### core.asyncã¨ã®é€£æº {#70c3da}

manifoldã®streamã¯core.asyncã®channelã«å¤‰æ›ã§ãã‚‹.

```clojure
(def c (async/chan))
(def s (s/->source c))
(def s (s/->sink c))
```

connectã‚’ã¤ã‹ã£ã¦é€£çµã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹.

```clojure
(s/connect s c)
```


### dirigiste {#7c5790}

Manifoldã®å†…éƒ¨ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹. Java Thread Poolã®æ”¹é€ .

<https://github.com/clj-commons/dirigiste>


### ğŸ’¡ã‚½ãƒ¼ã‚¹é›»æµã¨ã‚·ãƒ³ã‚¯é›»æµ {#b79f0d}

source, sink. manifoldã®å°‚é–€ç”¨èªã¨ã„ã†ã‚ã‘ã§ã¯ãªã, å¾ªç’°ã‚’ç¤ºã™ç‰©ç†ã‚„é›»å­å·¥å­¦ã§ã‚‚ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã .

sinkã®æ„å‘³ã¯æ²ˆã‚€ã§ã‚ã‚Š, å°æ‰€ã®æµã—å°, ãªã«ã‹ãŒæºœã¾ã£ã¦ã„ãã¨ã“ã‚. ãã“ã‹ã‚‰å¸ã„è¾¼ã¿é›»æµ(ã‚·ãƒ³ã‚¯é›»æµ).

sourceã®æ„å‘³ã¯æºã§ã‚ã‚Š, ãªã«ã‹ãŒå‡ºã¦ãã‚‹ã¨ã“ã‚, ãã“ã‹ã‚‰åãå‡ºã—é›»æµ(ã‚½ãƒ¼ã‚¹é›»æµ).

-   [ã€åãå‡ºã—é›»æµ(ã‚½ãƒ¼ã‚¹é›»æµ)ã€ã¨ã€å¸ã„è¾¼ã¿é›»æµ(ã‚·ãƒ³ã‚¯é›»æµ)ã€ã®é•ã„ã«ã¤ã„ã¦ï¼](https://detail-infomation.com/source-current-and-sink-current/)


## aleph Topics {#b28273}


### alephæ¥ç¶šãã‚Œã‚‹å•é¡Œ {#114405}

ã©ã†ã‚‚alephã«ã¯é€”ä¸­ã§æ¥ç¶šãŒé€”åˆ‡ã‚Œã‚‹ã‚ˆã†ãªã“ã¨ãŒè¦‹å—ã‘ã‚‰ã‚Œã‚‹.

[clojure - How to ensure websocket connection is kept alive in Aleph - Stack Overflow](https://stackoverflow.com/questions/34870519/how-to-ensure-websocket-connection-is-kept-alive-in-aleph)
[Aleph - can it handle client disconnect? : Clojure](https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/%20)

ã“ã®redditã«ã¯ä½œè€…æœ¬äººç™»å ´ã—ã¦workaroundã‚’è§£èª¬.

[Managing Websocket Stability issues with Aleph? : Clojure](https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/)

[sente]({{< relref "20220209102028.md#21f6271d-81ee-4219-86ce-c3a843e8e825" >}})ã‚’ä½¿ãˆã¨ã„ã†æ„è¦‹ã‚‚? æ¨æ¸¬ã ãŒ, websocketãŒãã†ã„ã†ã‚‚ã®ã§ã‚ã‚Šãã‚Œã‚’æ”¹è‰¯ã—ãŸã‚‚ã®ãŒ[Socket.IO]({{< relref "20220801202422.md#ac32b357-4cfd-456e-98e9-910add42c36d" >}})ãªã®ã‹ã‚‚(socket.ioã®clojure libraryã‚’æ¢ã—ä¸­).


## ğŸ”—References {#3b90d2}

-   [A Tour of Manifoldâ€™s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)
-   [Manifold stream/consume, is each execution of consumpe blocking within the stream? : Clojure](https://www.reddit.com/r/Clojure/comments/47ht3e/manifold_streamconsume_is_each_execution_of/)
-   [Manifold basics in a nutshell.pdf - Speaker Deck](https://speakerdeck.com/somiel/manifold-basics-in-a-nutshell)


### examples {#bfebe3}

-   <https://github.com/lmchoi/crypto-arb/blob/master/src/crypto_arb/exchanges/common/feeds.clj>
-   <https://github.com/skyscraper/algo-trader/blob/master/src/algo_trader/handlers/utils.clj>


## See also {#611114}

-   [ğŸ“Clojure: core.async]({{< relref "20220118091058.md" >}})
-   [âš–core.async vs Manifoldã®æ¯”è¼ƒ]({{< relref "20220116191927.md#72de97a6-0f59-43a5-a837-f0edefb744cb" >}})
