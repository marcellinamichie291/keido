+++
title = "ğŸ“Clojure: Manifold"
lastmod = 2022-10-14T21:53:23+09:00
tags = ["WIKI", "Clojure"]
draft = false
+++

-   up: [ğŸ“Clojure State and Concurrency]({{< relref "20220116191927.md" >}})
-   links
    -   <https://github.com/clj-commons/manifold>


## ğŸ“Manifoldã¨ã¯ {#370573}

éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãŸã‚ã®éƒ¨å“ã‚’æä¾›.

2ã¤ã®æŠ½è±¡ãŒãƒã‚¤ãƒ³ãƒˆ.

-   deferreds
-   streams

deferredsã¨ã¯èãæ…£ã‚Œãªã„ãŒ, å»¶æœŸ, å…ˆå»¶ã°ã—ã®æ„å‘³. é…å»¶è©•ä¾¡ã¨ã„ã†ã“ã¨ã‹ãª? streamã¯ä¸¦è¡Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ãŠã‘ã‚‹[Streams]({{< relref "20220116195030.md#d1bfb9ba-5970-4e9e-ae14-ed2d2c692f81" >}})ã®æ¦‚å¿µ.

-   [manifold/doc](https://github.com/clj-commons/manifold/tree/master/doc) : GitHubã®READMEãŒè©³ã—ã„.
-   <https://cljdoc.org/d/manifold/manifold/>: API doc

Manifoldã®Streamã‚’åˆ©ç”¨ã—ã¦ä½œã‚‰ã‚ŒãŸé€šä¿¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ[aleph](#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8). alephã®æ–¹ã«ã‚‚Manifoldã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚‹.


### Base Concepts {#64345e}

**deferred**, ã¾ãŸã¯deferred valuesã¯é…å»¶ã•ã‚ŒãŸå€¤ã¨ã„ã†æ„å‘³. è©•ä¾¡ã•ã‚Œã¦ã„ãªã„å€¤. <<... >>ã¨ã„ã†ã‚ˆã†ãªäºŒé‡ã‚«ãƒƒã‚³ã§è¡¨ç¾ã•ã‚Œã‚‹. asynchronous valueã¨ã‚‚ã„ã‚ã‚Œã‚‹. Clojureã®promiseã«callbackã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ãªæ‹¡å¼µæ©Ÿèƒ½.

deferred valueã«ãªã«ã‹ãŒbindã•ã‚Œã‚‹ã¨ **realized** ã¨ã„ã†è¡¨ç¾ã‚’ã¤ã‹ã£ã¦ã„ã‚‹. deferredã®å¯¾æ¦‚å¿µãŒrealized.

**stream** ã¯, deferred valuesã®ãƒªã‚¹ãƒˆ. **sink** ã¯ æƒ…å ±ã‚’æ¶ˆè²»(consume)ã™ã‚‹stream, **source** ã¯æƒ…å ±ã‚’ç”Ÿã¿å‡ºã™(produce)stream. ã“ã‚Œã‚‰ã®source/sinkã®2ã¤ã®streamãŒã‚»ãƒƒãƒˆã¨ã—ã¦ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å…¥ã£ã¦ã„ã‚‹. duplex streamã¨ã„ã†.

Manifoldã«ãŠã‘ã‚‹streamsã¯ã“ã®sinkã¨sourceã®ä¸¡æ–¹ã‚’ä½µã›æŒã¤ã‚³ãƒ³ã‚»ãƒ—ãƒˆ. sinkã«å¯¾ã—ã¦put!ã—ã¦, sourceã«å¯¾ã—ã¦take!ã™ã‚‹. Manifoldã®streamã§è¿”ã•ã‚Œã‚‹ã®ã¯duplex streamã®deferredã•ã‚ŒãŸçŠ¶æ…‹ã§ã‚ã‚‹ã®ã§, duplexã®æ§‹é€ ã¯å†…éƒ¨ã«éš è”½ã•ã‚Œã¦ã„ã‚‹ã®ã§è¤‡æ•°å½¢ã®streamsã§ã¯ãªãå˜æ•°å½¢ã®streamã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã¨ã“ã‚ã¯å°‘ã—ã‚„ã‚„ã“ã—ã„.

ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ä¸€èˆ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¯[âš™Pipelineãƒ‘ã‚¿ãƒ¼ãƒ³]({{< relref "20221008220000.md#f65e0d32-5d7c-4ab5-a5cc-aab61182ff80" >}})ã«ã¾ã¨ã‚ãŸ.


### Deferreds {#a2c9c2}

<https://github.com/clj-commons/manifold/blob/master/doc/deferred.md>

deferred valueã¯@ã ã£ãŸã‚Šderefã§èª­ã‚€.

deferred valuesã¨ã¯ã„ã‚ã°ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¤‰æ•°ã§ã‚ã‚‹([ğŸ¤”Clojureã®promise/deliverã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¤‰æ•°ã®ã“ã¨]({{< relref "20220116191927.md#9b145138-9ed9-431d-a2a3-3146e607c72d" >}})).

**chain** ã‚’ã¤ã‹ã†ã¨, é…å»¶å®Ÿè¡Œé–¢æ•°ã‚’é–¢æ•°åˆæˆ(composing)ã§ãã‚‹. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¤‰æ•°ã‚’å¼•æ•°ã«ã¨ã‚‹[Threading Macros]({{< relref "20220116083656.md#508f51c6-37cb-4b61-9bce-91075f1f067e" >}})ãŒæ§‹ç¯‰ã§ãã‚‹.


### Streams {#21b3cb}

ref. <https://github.com/clj-commons/manifold/blob/master/doc/stream.md>

streamã®å‹ã‚’typeã§èª¿ã¹ã‚‹ã¨, SplicedStreamã¨ãªã‚‹. spliceã¯ä½™ã‚Šãã‹ãªã„è‹±å˜èªã ãŒ, é€£çµã•ã‚ŒãŸã®æ„.

---

ãªã«ã‚‚å–ã‚Šå‡ºã›ãªã„çŠ¶æ…‹, ç©ºã®sourceã¯ **drained** (æ¯æ¸‡)ã¨ã„ã†çŠ¶æ…‹ã«ãªã‚‹.

ã“ã®ã¨ã, streamã‹ã‚‰take!ã™ã‚‹ã¨nilãŒå¸°ã£ã¦ãã‚‹. nilãŒæ„å›³ã—ã¦å…¥åŠ›ã•ã‚ŒãŸå€¤(valid message)ãªã®ã‹, ç©ºã‚’ç¤ºã™ã‚‚ã®ãªã®ã‹ã‚’æ˜ç¢ºã«åŒºåˆ¥ã—ãŸã„ã¨ãã¯, take!ã®optionå¼•æ•°ã§::drainedã‚’æ¸¡ã™.

```clojure
> @(s/take! s ::drained)
::drained

;; ã‚µãƒ³ãƒ—ãƒ«ã§ã¯identical?ã§æ¯”è¼ƒã—ã¦ã„ãŸ.
(when (identical? ::drained msg)
  :a)
```

---

**consume** ã¯streamã«å…¥ã£ã¦ã„ã‚‹å€¤ã‚’å…¨éƒ¨å–ã‚Šå‡ºã—ã¦ä¸€ã¤ãšã¤callbacké–¢æ•°ã‚’é©ç”¨ã™ã‚‹. take! ã‚’ã§åŒã˜ã“ã¨ã‚’ã™ã‚‹ã«ã¯, loop/recurã§ä¸€ã¤ãšã¤å–ã‚Šå‡ºã—ãŸä¸Šã§é–¢æ•°ã‚’é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹.

```clojure
(s/consume #(println %) sock)

(defn my-consume [sock]
  (d/loop []
    (d/chain (s/take! sock ::drained)
             (fn [msg]
               (if (identical? ::drained msg)
                 ::drained
                 (println msg)))

             (fn [result]
               (when-not (identical? ::drained result)
                 (d/recur))))))
```


### Event-Bus {#0637bb}

[âš™Publisher-Subscriberãƒ‘ã‚¿ãƒ¼ãƒ³]({{< relref "20221008220000.md#0b8b761b-2fb9-48f1-9777-cc09e92bed6c" >}})ã‚’å®Ÿç¾ã‚‹ã™ãŸã‚ã®æ©Ÿèƒ½.

ã‚ã¾ã‚Šæƒ…å ±ãŒãªã„ãŒ, ä»¥ä¸‹ã®è¨˜äº‹ã¯è©³ã—ã„.

[A Tour of Manifoldâ€™s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)

ã‚‚ã—ãã¯core.asyncã® [pub/sub]({{< relref "20220118091058.md#7c997455-af40-4663-b841-7b0e6f39ec19" >}})ã‹ã‚‰é¡æ¨.

[Zach Tellman - Everything Will Flow - YouTube](https://www.youtube.com/watch?v=1bNOO3xxMc0&t=1887s)


## ğŸ“Clojure: aleph {#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8}

éåŒæœŸé€šä¿¡ã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª.

(core.asyncã§ã¯ãªã)[ğŸ“Manifold]({{< relref "20221013151243.md" >}})ã®Streamã‚’Baseã«ã—ãŸä¸¦è¡Œåˆ¶å¾¡ã¨[Netty]({{< relref "20221011163921.md#08d70e13-298f-49af-a58d-c0dbeb76d660" >}})ã«ã‚ˆã‚‹éåŒæœŸé€šä¿¡ã‚’Baseã«ã—ã¦ã„ã‚‹.

READMEã«ã‚ˆã‚‹ã¨, HTTPé€šä¿¡ã¯[clj-http]({{< relref "20220209102028.md#13a79f1f-0d95-4f2a-8c4c-b77c4ed69be1" >}})ã®mimicã‚’ç›®æŒ‡ã™. mimicã¨ã¯ãªã‚“ã ?èª¿ã¹ãŸæ¨¡å€£ã¨ã„ã†æ„å‘³ã‚‰ã—ã„.

---

-   <https://aleph.io/aleph/http.html>
-   <https://aleph.io/examples/literate.html>
-   <https://aleph.io/codox/manifold/index.html>
-   [GitHub - clj-commons/aleph: Asynchronous communication for Clojure](https://github.com/clj-commons/aleph)

å‚è€ƒè¨˜äº‹.

-   [aleph/lamina: Clojureã§ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆWebSocket - Qiita](https://qiita.com/federkasten/items/8d10f12f049aec9a236f)
-   [Clojure: aleph.tcpã‚’ä½¿ã£ã¦http echoã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã£ã¦éŠã¶ - Qiita](https://qiita.com/temp_la/items/866a58f60bcd2e5593e4)


### Aleph Websocket Clinet Examples {#ea9a50}

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®Websocketå®Ÿè£…ä¾‹.

```clojure
(def ws-url "wss://ws.lightstream.bitflyer.com/json-rpc")
(def sock @(websocket-client ws-url))

(let [msg
      {:method "subscribe"
       :params {:channel "lightning_ticker_FX_BTC_JPY"}}]
  (s/put! sock (generate-string msg)))
```

-   [Using Aleph as a Clojure WebSocket Client | Matthew Downey](https://matthewdowney.github.io/aleph-websocket-client-not-jetty.html)


## Manifold Topics {#2ab9b4}


### streamã®çŠ¶æ…‹ã‚’èª¿ã¹ã‚‹é–¢æ•° {#db3c19}

ã„ã‚ã„ã‚ã‚ã‚‹ãŒ, descriptionã¨ã„ã†é–¢æ•°ã§å…¨éƒ¨Mapã§æƒ…å ±ãŒå–ã‚Œã‚‹.

-   drained?
-   sink?
-   source?
-   closed?
-   stream?


### core.asyncã¨ã®é€£æº {#70c3da}

manifoldã®streamã¯core.asyncã®channelã«å¤‰æ›ã§ãã‚‹.

```clojure
(def c (async/chan))
(def s (s/->source c))
(def s (s/->sink c))
```

connectã‚’ã¤ã‹ã£ã¦é€£çµã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹.

```clojure
(s/connect s c)
```


### takeã§å–ã‚Šå‡ºã—ç¶šã‘ã‚‹ {#a0834f}

loop-recurã®å†å¸°ã®ãªã‹ã§takeã‚’å‘¼ã³å‡ºã—ç¶šã‘ã‚‹ã“ã¨ã§å–ã‚Šå‡ºã™.

d/loopé–¢æ•°ã¯clojure.core/loopã‚’æ‹¡å¼µã—ãŸé…å»¶ãƒ«ãƒ¼ãƒ—ã®ãƒã‚¯ãƒ­ã§ã“ã®ä¸­ã§defered streamã‹ã‚‰take!ã™ã‚‹ã“ã¨ãŒã§ãã‚‹.

æ³¨æ„ã¨ã—ã¦ã¯, core.asyncã®goroutineã®ã‚ˆã†ãªè»½é‡ã‚¹ãƒ¬ãƒƒãƒ‰ãªã‚ã‘ã§ã¯ãªã„. ã“ã£ã¡ã®æ©Ÿèƒ½ã‚‚å¿…è¦ãªã‚‰ã°, defered streamã‚’core.asyncã®channelã«å¤‰æ›ã—ã¦go-loopã‚’ã¤ã‹ã†ã‹, d/go-offé–¢æ•°ã‚’ã¤ã‹ã†.

[ğŸ’¡æ€§èƒ½ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒCPUãƒã‚¦ãƒ³ãƒ‰ã‹IOãƒã‚¦ãƒ³ãƒ‰ã‹]({{< relref "20220118091058.md#08a59092-35e5-47a2-8361-84a1b25f283f" >}})


### dirigiste {#7c5790}

Manifoldã®å†…éƒ¨ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹. Java Thread Poolã®æ”¹é€ .

<https://github.com/clj-commons/dirigiste>


## aleph Topics {#b28273}


### alephæ¥ç¶šãã‚Œã‚‹å•é¡Œ {#114405}

ã©ã†ã‚‚alephã«ã¯é€”ä¸­ã§æ¥ç¶šãŒé€”åˆ‡ã‚Œã‚‹ã‚ˆã†ãªã“ã¨ãŒè¦‹å—ã‘ã‚‰ã‚Œã‚‹.

[clojure - How to ensure websocket connection is kept alive in Aleph - Stack Overflow](https://stackoverflow.com/questions/34870519/how-to-ensure-websocket-connection-is-kept-alive-in-aleph)
[Aleph - can it handle client disconnect? : Clojure](https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/%20)

ã“ã®redditã«ã¯ä½œè€…æœ¬äººç™»å ´ã—ã¦workaroundã‚’è§£èª¬.

[Managing Websocket Stability issues with Aleph? : Clojure](https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/)

[sente]({{< relref "20220209102028.md#21f6271d-81ee-4219-86ce-c3a843e8e825" >}})ã‚’ä½¿ãˆã¨ã„ã†æ„è¦‹ã‚‚? æ¨æ¸¬ã ãŒ, websocketãŒãã†ã„ã†ã‚‚ã®ã§ã‚ã‚Šãã‚Œã‚’æ”¹è‰¯ã—ãŸã‚‚ã®ãŒ[Socket.IO]({{< relref "20220801202422.md#ac32b357-4cfd-456e-98e9-910add42c36d" >}})ãªã®ã‹ã‚‚(socket.ioã®clojure libraryã‚’æ¢ã—ä¸­).


## Manifold Insights {#571cdc}


### ğŸ¤”é…å»¶å®Ÿè¡Œé–¢æ•°åˆæˆã¨ã„ã†æ™‚ç©ºã‚’è¶…ãˆãŸæ“ä½œã®æ•°ç ã‚Š {#86cdfc}

Manifold chainãŒé¢ç™½ã„ã®ã¯, é…å»¶å®Ÿè¡Œé–¢æ•°ãŒé€£ç¶šã—ã¦ã„ã‚‹ã¨ã.

ä»¥ä¸‹ã®1è¡Œç›®, 2è¡Œç›®, 3è¡Œç›®ã¯ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§realizedã•ã‚Œã‚‹ã‹ã¯æ±ºã¾ã£ã¦ã„ãªã„ã‚‚ã®ã®, æ™‚ç©ºã‚’è¶…ãˆã¦å€¤ã‚’é †ç•ªé€šã‚Šã«æ“ä½œã§ãã‚‹. ã“ã‚ŒãŒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ, é…å»¶å®Ÿè¡Œé–¢æ•°åˆæˆã®é¢ç™½ã•. 1è¡Œç›®ã®dãŒrealizedã•ã‚Œã‚‹ã®ãŒ10å¹´å¾Œã ã‚ã†ãŒ, 2è¡Œç›®ã®futureã®å®Ÿè¡Œã«100ä¸‡å¹´ã‹ã‹ã‚ã†ãŒ, ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­ã§å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‰ã‚Œã‚‹. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¤‰æ•°ã¯ä¸¦è¡Œå‡¦ç†ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹.

```clojure
(d/chain d
    #(future (inc %))
    #(future (inc %))
    #(println "the future returned" %))
```


## ğŸ”—References {#3b90d2}

-   [A Tour of Manifoldâ€™s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)
-   [Manifold stream/consume, is each execution of consumpe blocking within the stream? : Clojure](https://www.reddit.com/r/Clojure/comments/47ht3e/manifold_streamconsume_is_each_execution_of/)
-   [Manifold basics in a nutshell.pdf - Speaker Deck](https://speakerdeck.com/somiel/manifold-basics-in-a-nutshell)
-   <https://github.com/search?l=Clojure&q=websocket-client+manifold&type=Code>


## See also {#611114}

-   [ğŸ“Clojure: core.async]({{< relref "20220118091058.md" >}})
-   [âš–core.async vs Manifoldã®æ¯”è¼ƒ]({{< relref "20220116191927.md#72de97a6-0f59-43a5-a837-f0edefb744cb" >}})
-   [ğŸ“æ±ºå®šæ€§ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°]({{< relref "20221008195738.md" >}})
